<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UniWorld</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">

    <!-- Pure CSS Stylesheet (No Tailwind) -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FIREBASE SDK SETUP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = { initializeApp, getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, sendEmailVerification, getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, serverTimestamp };
    </script>

    <script>
        // --- CORE UTILITIES ---
        function getEl(id) { return document.getElementById(id); }

        function showView(name) {
            ['auth-view', 'app-view'].forEach(id => getEl(id).classList.add('hidden'));
            getEl(name + '-view').classList.remove('hidden');
        }

        function toggleSidebar(show) {
            const sb = getEl('sidebar'), ov = getEl('overlay');
            show ? (sb.classList.add('open'), ov.classList.add('visible')) : (sb.classList.remove('open'), ov.classList.remove('visible'));
        }

        function switchPanel(panelId) {
            if (window.innerWidth < 768) toggleSidebar(false);
            // FIXED: Only hide panels that actually exist as main views
            ['room-list-panel', 'chat-interface'].forEach(p => {
                const el = getEl(p);
                if(el) el.classList.add('hidden');
            });
            const panel = getEl(panelId);
            if(panel) panel.classList.remove('hidden');
            if(panelId === 'chat-interface') getEl('msg-box').scrollTop = getEl('msg-box').scrollHeight;
        }

        function resetModal() {
            getEl('modal-input').classList.add('hidden');
            getEl('modal-input').value = '';
            getEl('modal-cancel-btn').classList.add('hidden');
            getEl('custom-modal-backdrop').classList.add('hidden');
        }

        let confirmCallback = null;
        function closeModal(result) {
            getEl('custom-modal-backdrop').classList.add('hidden');
            if (confirmCallback) { 
                const cb = confirmCallback;
                confirmCallback = null; 
                cb(result); 
            }
        }

        function showCustomAlert(message, title = 'System Alert') {
            resetModal();
            getEl('modal-title').textContent = title;
            getEl('modal-message').textContent = message;
            getEl('modal-ok-btn').textContent = 'OK';
            getEl('custom-modal-backdrop').classList.remove('hidden');
            setTimeout(() => getEl('modal-ok-btn').focus(), 50);
            confirmCallback = null;
        }

        function showCustomConfirm(message, callback, title = 'Confirm', okText = 'Yes', cancelText = 'Cancel') {
            resetModal();
            getEl('modal-title').textContent = title;
            getEl('modal-message').textContent = message;
            getEl('modal-cancel-btn').classList.remove('hidden');
            getEl('modal-ok-btn').textContent = okText;
            getEl('modal-cancel-btn').textContent = cancelText;
            getEl('custom-modal-backdrop').classList.remove('hidden');
            setTimeout(() => getEl('modal-ok-btn').focus(), 50);
            confirmCallback = callback;
        }

        function showCustomPrompt(message, callback, title = 'Input', placeholder = '', isPassword = false) {
            resetModal();
            getEl('modal-title').textContent = title;
            getEl('modal-message').textContent = message;
            getEl('modal-cancel-btn').classList.remove('hidden');
            getEl('modal-ok-btn').textContent = 'Submit';
            const input = getEl('modal-input');
            input.classList.remove('hidden');
            input.type = isPassword ? 'password' : 'text';
            input.placeholder = placeholder;
            getEl('custom-modal-backdrop').classList.remove('hidden');
            setTimeout(() => input.focus(), 50);
            confirmCallback = (result) => { result === true ? callback(input.value) : callback(null); };
        }

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = !html.classList.contains('light');
            setTheme(isDark ? 'light' : 'dark');
        }

        function setTheme(mode) {
            const html = document.documentElement;
            const icon = getEl('theme-toggle-icon');
            
            if (mode === 'light') {
                html.classList.add('light');
                html.classList.remove('dark');
                localStorage.setItem('uniworld-theme', 'light');
                if(icon) icon.classList.replace('fa-sun', 'fa-moon');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                localStorage.setItem('uniworld-theme', 'dark');
                if(icon) icon.classList.replace('fa-moon', 'fa-sun');
            }
        }
        
        function setInlineError(id, msg) {
            getEl(id).textContent = msg;
        }
        function clearInlineErrors() {
            document.querySelectorAll('.inline-error').forEach(el => el.textContent = '');
        }
        
        function openProfileModal() {
            getEl('profile-overlay').classList.add('visible');
            if (window.innerWidth < 768) toggleSidebar(false);
        }
        function closeProfileModal() {
            getEl('profile-overlay').classList.remove('visible');
        }
        
        function openInviteModal(roomId) {
            getEl('invite-overlay').classList.add('visible');
            const link = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            getEl('invite-link-text').value = link;
        }
        function closeInviteModal() {
            getEl('invite-overlay').classList.remove('visible');
        }
        function copyInviteLink() {
            const input = getEl('invite-link-text');
            input.select();
            input.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(input.value).then(() => {
                showCustomAlert("Link copied to clipboard!", "Success");
                closeInviteModal();
            }).catch(err => {
                console.error(err);
                showCustomAlert("Failed to copy automatically.", "Error");
            });
        }
        function handleModalKey(e) { if(e.key === 'Enter') closeModal(true); }
        function togglePassword(inputId, iconId) {
            const input = getEl(inputId);
            const icon = getEl(iconId);
            if(input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        // --- APP LOGIC ---
        const firebaseConfig = {
            apiKey: "AIzaSyC6K-Gxi6WhT298CFxo6YfwaQjx_jgYO8s",
            authDomain: "wisp-67568.firebaseapp.com",
            projectId: "wisp-67568",
            storageBucket: "wisp-67568.firebasestorage.app",
            messagingSenderId: "713497967554",
            appId: "1:713497967554:web:9c64466d6896f7fa7f745b",
            measurementId: "G-6PREKBM1GP"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'uniworld-chat-v2';
        
        let app, auth, db;
        let currentUser = null; 
        let currentRoomId = null;
        let currentRoomData = null; 
        let roomUnsubscribe = null;
        let messageUnsubscribe = null;
        let profileUnsubscribe = null;
        let typingUnsubscribe = null; 
        
        let profileCache = {}; 
        let allRoomsCache = []; 
        const NEARBY_RADIUS_KM = 10; 
        
        let lastTypingTime = 0;
        const TYPING_THROTTLE = 2000; 

        async function sha256Hex(message) {
            const enc = new TextEncoder();
            const data = enc.encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
        }

        window.addEventListener('load', () => {
            // Load theme
            const savedTheme = localStorage.getItem('uniworld-theme') || 'dark';
            setTheme(savedTheme);

            const checkModules = setInterval(() => {
                if (window.firebaseModules) {
                    clearInterval(checkModules);
                    initFirebase();
                }
            }, 100);
            
            getEl('l-pass').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') handleLogin();
            });
            
            getEl('room-search').addEventListener('input', (e) => filterRooms(e.target.value));
            
            getEl('msg-inp').addEventListener('input', (e) => {
                handleChatInput(e);
                handleTypingInput();
            });
            getEl('msg-inp').addEventListener('keydown', handleChatKeydown);
        });

        function initFirebase() {
            const { initializeApp, getAuth, getFirestore, onAuthStateChanged } = window.firebaseModules;
            
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            const radiusEl = document.getElementById('radius-display');
            if(radiusEl) radiusEl.textContent = `within ${NEARBY_RADIUS_KM}km`;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    if(user.emailVerified) {
                        currentUser = user; // Set currentUser here for app access
                        handleSession(user);
                        getEl('verification-view').classList.add('hidden');
                        getEl('f-login').classList.remove('hidden');
                    } else {
                        // Email not verified, block app access, show verification view
                        currentUser = user; // Keep user for resend capability
                        showView('auth');
                        getEl('f-login').classList.add('hidden');
                        getEl('f-signup').classList.add('hidden');
                        getEl('verification-view').classList.remove('hidden');
                        getEl('v-email-display').textContent = user.email;
                    }
                } else {
                    currentUser = null;
                    showView('auth');
                    getEl('verification-view').classList.add('hidden');
                    getEl('f-login').classList.remove('hidden');
                }
            });

            window.addEventListener('resize', () => {
                if(window.innerWidth >= 768) { getEl('sidebar').classList.remove('open'); getEl('overlay').classList.remove('visible'); }
            });
            
            setInterval(updateTimers, 60000);
        }

        const getPublicCollection = (name) => window.firebaseModules.collection(db, 'artifacts', appId, 'public', 'data', name);
        
        async function handleSession(user) {
            showView('app');
            
            const urlParams = new URLSearchParams(window.location.search);
            const deepLinkRoomId = urlParams.get('room');

            const { doc, getDoc, setDoc, updateDoc } = window.firebaseModules;
            const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', user.uid);
            
            try {
                const snap = await getDoc(profileRef);
                if (snap.exists()) {
                    const data = snap.data();
                    profileCache[user.uid] = data;
                    updateMyProfileUI(data);
                } else {
                    const avatar = `https://api.dicebear.com/9.x/bottts-neutral/svg?seed=${user.uid}`;
                    const newProfile = { 
                        id: user.uid, 
                        username: 'User-'+user.uid.slice(0,6), 
                        username_lower: ('User-'+user.uid.slice(0,6)).toLowerCase(), 
                        alias: '', 
                        email: user.email || null, 
                        avatar, 
                        status: 'online',
                        lat: null, lon: null
                    };
                    await setDoc(profileRef, newProfile);
                    profileCache[user.uid] = newProfile;
                    updateMyProfileUI(newProfile);
                }
            } catch (err) {
                console.error("Profile fetch error.", err);
            }

            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async pos => {
                    try {
                        await updateDoc(profileRef, { lat: pos.coords.latitude, lon: pos.coords.longitude });
                    } catch(e) {}
                }, err => console.warn(err));
            }

            initializeRealtime();
            
            if (deepLinkRoomId) {
                window.history.replaceState({}, document.title, window.location.pathname);
                try {
                    const roomDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', deepLinkRoomId));
                    if (roomDoc.exists()) {
                        const r = { id: roomDoc.id, ...roomDoc.data() };
                        openRoom(r.id, r.name, r.password_hash, r);
                    } else {
                        showCustomAlert("Room not found or expired.", "Deep Link Error");
                    }
                } catch(e) {
                    console.error("Deep link fetch error", e);
                }
            }
        }

        function updateMyProfileUI(data) {
            const avatarEl = getEl('my-avatar');
            if(avatarEl) avatarEl.src = data.avatar || '';
            const nameEl = getEl('my-name');
            if(nameEl) nameEl.textContent = data.username || 'Anon User';
            
            getEl('edit-username').value = data.username || '';
            getEl('edit-alias').value = data.alias || ''; 
            getEl('edit-bio').value = data.bio || '';
            getEl('edit-avatar').value = data.avatar || '';
            getEl('edit-avatar-preview').src = data.avatar || '';
            
            const el = getEl('status-indicator');
            if(el) {
                el.style.color = 'var(--green-500)';
                el.classList.remove('text-gray-500'); // Keep JS clean, though styling is now CSS
            }
        }

        function initializeRealtime() {
            const { onSnapshot } = window.firebaseModules;
            const roomsCol = getPublicCollection('rooms');
            if(roomUnsubscribe) roomUnsubscribe();
            roomUnsubscribe = onSnapshot(roomsCol, (snapshot) => {
                const rooms = [];
                snapshot.forEach(doc => rooms.push({ id: doc.id, ...doc.data() }));
                allRoomsCache = rooms;
                filterRooms(getEl('room-search').value);
            }, (err) => console.error("Rooms listen error", err));

            const profilesCol = getPublicCollection('profiles');
            if(profileUnsubscribe) profileUnsubscribe();
            profileUnsubscribe = onSnapshot(profilesCol, (snapshot) => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    profileCache[data.id] = data;
                    updateUserInUI(data);
                    if(currentUser && data.id === currentUser.uid) updateMyProfileUI(data);
                });
                renderUserList();
            }, (err) => console.error("Profiles listen error", err));
        }

        function filterRooms(searchText) {
            const now = Date.now();
            const filtered = allRoomsCache.filter(r => {
                if (r.is_dm) return false; // HIDE DMs
                if (r.expires_at && r.expires_at < now) return false;
                if (!searchText) return true;
                return r.name.toLowerCase().includes(searchText.toLowerCase());
            });
            
            filtered.sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
            renderRooms(filtered);
            renderMyRooms(); 
        }
        
        function clearSearch() {
            const inp = getEl('room-search');
            inp.value = '';
            filterRooms('');
            inp.focus();
        }

        function renderRooms(rooms) {
            const grid = getEl('room-grid');
            grid.innerHTML = '';
            if(rooms.length) {
                rooms.forEach(r => grid.appendChild(createRoomCard(r)));
            } else {
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; color:var(--text-muted); padding: 2.5rem; opacity:0.5; font-family:monospace;">No rooms found.<br>Adjust filters or create one.</div>`;
            }
        }

        function renderMyRooms() {
            const list = getEl('my-rooms-list');
            list.innerHTML = '';
            const now = Date.now();
            
            const myRooms = allRoomsCache.filter(r => 
                r.created_by === currentUser.uid && 
                (!r.expires_at || r.expires_at > now) &&
                !r.is_dm // HIDE DMs
            );

            if (myRooms.length === 0) {
                list.innerHTML = `<div style="color:var(--gray-600); font-size:0.75rem; padding:0.5rem; font-style:italic;">No active rooms</div>`;
                return;
            }

            myRooms.forEach(r => {
                const div = document.createElement('div');
                // UPDATED SEMANTIC CLASS
                div.className = 'sidebar-list-item group';
                const timeRemaining = getTimeRemaining(r.expires_at);
                
                div.innerHTML = `
                    <div class="sidebar-item-content">
                        <i class="fas fa-hashtag" style="color: var(--primary-hover); font-size: 0.75rem;"></i>
                        <div class="sidebar-item-text">${r.name}</div>
                    </div>
                    <div class="sidebar-item-sub">${timeRemaining}</div>
                `;
                div.onclick = () => openRoom(r.id, r.name, r.password_hash, r);
                list.appendChild(div);
            });
        }

        function createRoomCard(r) {
            const div = document.createElement('div');
            const isOwner = r.created_by === currentUser.uid;
            // UPDATED SEMANTIC CLASS
            div.className = 'room-card group';
            
            const lockHtml = r.password_hash ? `<i class="fas fa-lock" style="color: var(--yellow-400)" title="Locked room"></i>` : '';
            const deleteButtonHtml = isOwner ? 
                `<button onclick="event.stopPropagation(); deleteRoom('${r.id}')" class="btn-delete-room" title="Delete Room"><i class="fas fa-trash-alt" style="font-size:0.75rem;"></i></button>` : '';

            const timeStr = getTimeRemaining(r.expires_at);

            div.innerHTML = `
                <div class="room-card-header">
                    <div class="room-name"># ${r.name}</div>
                    ${lockHtml}
                </div>
                <div class="room-footer">
                    <div class="room-timer">
                        <i class="far fa-clock"></i> Ends in: <span class="expires-timer" data-expires="${r.expires_at}">${timeStr}</span>
                    </div>
                    <div class="room-tags">
                        <div class="tag-badge">${isOwner ? 'OWNER' : 'PUBLIC'}</div>
                        ${deleteButtonHtml}
                    </div>
                </div>
            `;
            div.onclick = () => openRoom(r.id, r.name, r.password_hash, r);
            return div;
        }

        function getTimeRemaining(expiresAt) {
            if (!expiresAt) return "∞";
            const now = Date.now();
            const diff = expiresAt - now;
            if (diff <= 0) return "Expired";
            const hrs = Math.floor(diff / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            if(hrs > 0) return `${hrs}h ${mins}m`;
            return `${mins}m`;
        }

        function updateTimers() {
            document.querySelectorAll('.expires-timer').forEach(el => {
                const exp = parseInt(el.dataset.expires);
                if(exp) el.textContent = getTimeRemaining(exp);
            });
            if(currentRoomData) {
                const headerTimer = getEl('chat-header-timer');
                if(headerTimer) headerTimer.textContent = "Ends in: " + getTimeRemaining(currentRoomData.expires_at);
                
                if (currentRoomData.expires_at && Date.now() > currentRoomData.expires_at) {
                    showCustomAlert("This room has expired.", "Session Ended");
                    goBack();
                }
            }
            filterRooms(getEl('room-search').value);
        }

        function renderUserList() {
            const list = getEl('user-list');
            list.innerHTML = '';
            Object.values(profileCache).forEach(u => {
                if(u.id === currentUser.uid) return;
                const div = document.createElement('div');
                // UPDATED SEMANTIC CLASS
                div.className = 'sidebar-list-item';
                // LOGIC: Alias (no @) OR @Username
                const displayName = u.alias ? u.alias : '@' + u.username;
                
                div.innerHTML = `
                    <div class="sidebar-item-content" style="width:100%">
                        <div style="position:relative; flex-shrink:0;">
                            <img src="${u.avatar}" onerror="this.src='https://api.dicebear.com/7.x/bottts/svg?seed=fallback'" style="width:2rem; height:2rem; border-radius:50%; background:var(--gray-700); object-fit:cover;">
                            <div style="position:absolute; bottom:0; right:0; width:0.625rem; height:0.625rem; border-radius:50%; border:2px solid var(--panel); background-color:${u.status === 'online' ? 'var(--green-500)' : 'var(--gray-500)'}"></div>
                        </div>
                        <div style="overflow:hidden; min-width:0;">
                            <div class="sidebar-item-text">${displayName}</div>
                        </div>
                    </div>
                `;
                div.onclick = () => startDM(u);
                list.appendChild(div);
            });
        }

        function updateUserInUI(user) {
             const nameEls = document.querySelectorAll(`.username-display-${user.id}`);
             // LOGIC: Alias (no @) OR @Username
             const displayName = user.alias ? user.alias : '@' + user.username;
             nameEls.forEach(el => el.textContent = displayName);
             
             const imgEls = document.querySelectorAll(`.avatar-display-${user.id}`);
             imgEls.forEach(el => el.src = user.avatar);
        }

        async function openRoom(id, name, password_hash, roomData) {
            if(password_hash) {
                showCustomPrompt('This room is encrypted. Enter passphrase:', async (input) => {
                    if(input === null) return;
                    const hashed = await sha256Hex(input);
                    if(hashed !== password_hash) {
                        showCustomAlert('Access Denied: Invalid Passphrase.', 'Security Alert');
                        return;
                    }
                    enterRoom(id, name, roomData);
                }, 'Secure Room', '', true);
            } else {
                enterRoom(id, name, roomData);
            }
        }

        function enterRoom(id, name, roomData) {
            currentRoomId = id;
            currentRoomData = roomData;
            getEl('chat-header-name').textContent = name;
            
            const timerEl = getEl('chat-header-timer');
            timerEl.textContent = roomData && roomData.expires_at ? "Ends in: " + getTimeRemaining(roomData.expires_at) : "";

            // 2. INVITE LINK MODAL TRIGGER
            const inviteContainer = getEl('header-actions');
            inviteContainer.innerHTML = `<div style="display:flex; gap:1rem; color:var(--gray-500); font-size:1.125rem;"><i class="fas fa-search" style="cursor:pointer; display:none;"></i></div>`; 
            
            if (currentUser && roomData.created_by === currentUser.uid) {
                const btn = document.createElement('button');
                btn.className = "icon-btn";
                btn.style.color = "var(--primary)";
                btn.title = "Share Invite Link";
                btn.innerHTML = `<i class="fas fa-share-alt"></i>`;
                btn.onclick = () => openInviteModal(id);
                inviteContainer.prepend(btn);
            }

            switchPanel('chat-interface');
            listenToTyping(id); 
            
            setTimeout(() => {
                const inp = getEl('msg-inp');
                if(inp) inp.focus();
            }, 100);

            const box = getEl('msg-box');
            box.innerHTML = '<div style="display:flex; flex-direction:column; items-align:center; justify-content:center; margin-top:5rem; gap:0.75rem; text-align:center;"><i class="fas fa-circle-notch fa-spin" style="color:var(--primary); font-size:1.875rem;"></i><span style="font-size:0.75rem; font-family:monospace; color:rgba(245,158,11,0.5);">CONNECTING TO FREQUENCY...</span></div>';

            const { onSnapshot, query, where } = window.firebaseModules;
            const msgsCol = getPublicCollection('messages');
            const q = query(msgsCol, where('room_id', '==', id));

            if(messageUnsubscribe) messageUnsubscribe();
            
            messageUnsubscribe = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                
                messages.sort((a, b) => {
                    const tA = new Date(a.created_at).getTime();
                    const tB = new Date(b.created_at).getTime();
                    return tA - tB;
                });

                box.innerHTML = '';
                if(messages.length) {
                    messages.forEach(m => renderMessage(m));
                    box.scrollTop = box.scrollHeight;
                } else {
                    box.innerHTML = '<div id="empty-msg" style="display:flex; flex-direction:column; items-align:center; justify-content:center; height:100%; text-align:center; color:var(--gray-600); padding-bottom:5rem;"><i class="fas fa-satellite-dish" style="font-size:2.25rem; margin-bottom:1rem; opacity:0.2;"></i><p style="font-size:0.875rem; font-family:monospace;">Room is quiet.</p></div>';
                }
            }, (err) => {
                console.error("Message Error", err);
            });
        }

        function renderMessage(m, scroll = false, isOptimistic = false) {
            const box = getEl('msg-box');
            if(document.getElementById(`msg-${m.id}`)) return;

            const isMe = m.sender_id === currentUser.uid;
            let profile = profileCache[m.sender_id];
            
            if(!profile) {
                const shortId = m.sender_id ? m.sender_id.slice(0,4) : '????';
                profile = { id: m.sender_id, username: `Anon ${shortId}`, avatar: `https://api.dicebear.com/9.x/bottts-neutral/svg?seed=${m.sender_id}` };
                
                // Lazy Fetch
                const { doc, getDoc } = window.firebaseModules;
                getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', m.sender_id)).then(snap => {
                    if(snap.exists()) {
                        const d = snap.data();
                        profileCache[snap.id] = d;
                        updateUserInUI(d);
                    }
                });
            }

            // 18. Highlight Mentions in text
            let processedText = m.text;
            const mentionRegex = /@(\w+)/g; 
            processedText = processedText.replace(mentionRegex, (match) => {
                if(match.substring(1) === currentUser.username || match.substring(1) === profileCache[currentUser.uid]?.alias) {
                       return `<span class="mention">${match}</span>`;
                }
                return `<span style="color:var(--primary); font-weight:600;">${match}</span>`;
            });

            const div = document.createElement('div');
            div.id = `msg-${m.id}`;
            // UPDATED SEMANTIC CLASS
            div.className = `msg-row ${isMe ? 'mine' : 'theirs'} ${isOptimistic ? 'msg-pending' : ''}`;
            
            // LOGIC: Alias (no @) OR @Username
            const senderDisplayName = profile.alias ? profile.alias : '@' + profile.username;

            if (!isMe) {
                div.innerHTML = `
                    <img src="${profile.avatar}" class="avatar-display-${m.sender_id}" style="width:2rem; height:2rem; border-radius:50%; border:1px solid var(--gray-700); background:black; object-fit:cover; margin-bottom:0.25rem; cursor:pointer;" onclick="startDM({id: '${m.sender_id}', username: '${profile.username}', avatar: '${profile.avatar}', alias: '${profile.alias || ''}'})">
                    <div class="msg-bubble theirs group">
                        <div class="username-display-${m.sender_id}" style="font-size:0.75rem; color:var(--primary); font-weight:bold; margin-bottom:0.125rem; cursor:pointer; text-decoration:none;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'" onclick="startDM({id: '${m.sender_id}', username: '${profile.username}', avatar: '${profile.avatar}', alias: '${profile.alias || ''}'})">${senderDisplayName}</div>
                        <div style="word-break:break-word;">${processedText}</div>
                        <div style="font-size:9px; opacity:0.4; text-align:right; margin-top:0.25rem; font-family:monospace; user-select:none;">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="msg-bubble mine group">
                        <div style="word-break:break-word;">${processedText}</div>
                        <div style="font-size:9px; opacity:0.4; text-align:right; margin-top:0.25rem; font-family:monospace; user-select:none;">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                        ${!isOptimistic ? `<div class="msg-actions"><button onclick="deleteMessage('${m.id}')" class="delete-msg-btn"><i class="fas fa-trash-alt" style="font-size:14px;"></i></button></div>` : ''}
                    </div>
                `;
            }
            
            box.appendChild(div);
        }

        // 18. Mention Logic
        function handleChatInput(e) {
            const input = e.target;
            const val = input.value;
            const cursorPos = input.selectionStart;
            
            // Find the word being typed
            const textBeforeCursor = val.substring(0, cursorPos);
            const words = textBeforeCursor.split(/\s+/);
            const currentWord = words[words.length - 1];

            if(currentWord.startsWith('@')) {
                const queryStr = currentWord.substring(1).toLowerCase();
                showMentionDropdown(queryStr);
            } else {
                hideMentionDropdown();
            }
        }

        function handleChatKeydown(e) {
            const dropdown = getEl('mention-dropdown');
            if(dropdown.style.display === 'block') {
                if(e.key === 'Enter' || e.key === 'Tab') {
                    e.preventDefault();
                    // Select first option
                    const first = dropdown.querySelector('.mention-item');
                    if(first) insertMention(first.dataset.name);
                }
                if(e.key === 'Escape') hideMentionDropdown();
            }
        }

        function showMentionDropdown(queryStr) {
            const dropdown = getEl('mention-dropdown');
            dropdown.innerHTML = '';
            
            // Filter users
            const matches = Object.values(profileCache).filter(u => {
                if(u.id === currentUser.uid) return false;
                return u.username.toLowerCase().includes(queryStr) || (u.alias && u.alias.toLowerCase().includes(queryStr));
            });

            if(matches.length === 0) {
                hideMentionDropdown();
                return;
            }

            matches.forEach(u => {
                const div = document.createElement('div');
                // UPDATED SEMANTIC CLASS
                div.className = 'mention-item';
                // Pass the raw name (Alias or Username) to insert
                const nameToInsert = u.alias || u.username;
                div.dataset.name = nameToInsert; 
                
                // LOGIC: Alias (no @) OR @Username
                const displayName = u.alias ? u.alias : '@' + u.username;

                div.onclick = () => insertMention(nameToInsert);
                div.innerHTML = `
                    <img src="${u.avatar}" style="width:1.25rem; height:1.25rem; border-radius:50%;">
                    <span>${displayName}</span>
                `;
                dropdown.appendChild(div);
            });

            dropdown.style.display = 'block';
        }

        function hideMentionDropdown() {
            getEl('mention-dropdown').style.display = 'none';
        }

        function insertMention(name) {
            const input = getEl('msg-inp');
            const val = input.value;
            const cursorPos = input.selectionStart;
            const textBefore = val.substring(0, cursorPos);
            const textAfter = val.substring(cursorPos);
            const lastAt = textBefore.lastIndexOf('@');
            const newText = textBefore.substring(0, lastAt) + `@${name} ` + textAfter;
            
            input.value = newText;
            input.focus();
            hideMentionDropdown();
        }

        function handleTypingInput() {
            const now = Date.now();
            if (now - lastTypingTime > TYPING_THROTTLE) {
                lastTypingTime = now;
                updateTypingStatus(true);
            }
        }

        async function updateTypingStatus(isTyping) {
            if(!currentRoomId || !currentUser) return;
            const { doc, setDoc, deleteDoc, serverTimestamp } = window.firebaseModules;
            const typingRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId, 'typing', currentUser.uid);
            
            if(isTyping) {
                const myProfile = profileCache[currentUser.uid];
                await setDoc(typingRef, {
                    username: myProfile?.username || 'Anon',
                    updated_at: serverTimestamp()
                });
            } else {
                await deleteDoc(typingRef);
            }
        }

        function listenToTyping(roomId) {
            if(typingUnsubscribe) typingUnsubscribe();
            
            const { collection, onSnapshot, query } = window.firebaseModules;
            const typingCol = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', roomId, 'typing');
            
            typingUnsubscribe = onSnapshot(typingCol, (snapshot) => {
                const now = Date.now();
                const typers = [];
                
                snapshot.forEach(doc => {
                    if(doc.id === currentUser.uid) return; 
                    const data = doc.data();
                    const timestamp = data.updated_at ? data.updated_at.toMillis() : now;
                    if (now - timestamp < 10000) {
                        typers.push(data.username);
                    }
                });
                
                const indicator = getEl('typing-indicator');
                if(typers.length > 0) {
                    const text = typers.length === 1 ? `${typers[0]} is typing...` :
                                 typers.length === 2 ? `${typers[0]} and ${typers[1]} are typing...` :
                                 `Several people are typing...`;
                    indicator.innerHTML = `<span class="typing-dot">•</span> ${text}`;
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
        }

        async function sendMsg() {
            const inp = getEl('msg-inp');
            const text = inp.value.trim();
            if(!text || !currentRoomId) return;
            
            if (currentRoomData && currentRoomData.expires_at && Date.now() > currentRoomData.expires_at) {
                showCustomAlert("Room has expired. Cannot transmit.", "Error");
                return;
            }
            
            updateTypingStatus(false);

            const mentionUids = [];
            const mentionRegex = /@(\w+)/g;
            let match;
            while ((match = mentionRegex.exec(text)) !== null) {
                const identifier = match[1].toLowerCase();
                // Updated to find by username OR alias
                const user = Object.values(profileCache).find(u => 
                    u.username.toLowerCase() === identifier || 
                    (u.alias && u.alias.toLowerCase() === identifier)
                );
                if(user) mentionUids.push(user.id);
            }
            
            const tempId = 'temp-' + Date.now();
            const nowIso = new Date().toISOString();
            renderMessage({ id: tempId, room_id: currentRoomId, text: text, sender_id: currentUser.uid, created_at: nowIso }, true, true);
            getEl('msg-box').scrollTop = getEl('msg-box').scrollHeight;
            
            inp.value = '';
            inp.focus();
            hideMentionDropdown();
            const empty = getEl('empty-msg'); if(empty) empty.remove();

            const { addDoc } = window.firebaseModules;
            const msgsCol = getPublicCollection('messages');
            try {
                await addDoc(msgsCol, {
                    room_id: currentRoomId,
                    text: text,
                    sender_id: currentUser.uid,
                    created_at: nowIso,
                    mentions: [...new Set(mentionUids)] 
                });
                const tempEl = document.getElementById(`msg-${tempId}`);
                if(tempEl) tempEl.remove(); 
            } catch(err) {
                const el = document.getElementById(`msg-${tempId}`);
                if(el) { el.style.border = "1px solid red"; el.title = err.message; }
                showCustomAlert("Failed: " + err.message, 'Error');
            }
        }

        async function deleteMessage(id) {
            showCustomConfirm("Delete this message?", async (confirmed) => {
                if (!confirmed) return;
                const { deleteDoc, doc } = window.firebaseModules;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'messages', id));
                } catch(e) {
                    showCustomAlert("Delete Failed: " + e.message, 'Error');
                }
            }, 'Confirm Deletion', 'Delete');
        }

        async function createRoom() {
            showCustomPrompt("Enter Room Name:", async (name) => {
                if(!name) return;
                
                const { getDocs, query, where, addDoc } = window.firebaseModules;
                const roomsCol = getPublicCollection('rooms');
                
                const nameLower = name.trim().toLowerCase();
                const q = query(roomsCol, where('name_lower', '==', nameLower));
                const existing = await getDocs(q);
                
                if (!existing.empty) {
                    showCustomAlert("A room with this name already exists. Choose another name.", "Duplicate Error");
                    return;
                }

                showCustomPrompt("Set Password (optional):", async (pass) => {
                    let password_hash = null;
                    if(pass && pass.length > 0) {
                        password_hash = await sha256Hex(pass);
                    }
                    
                    try {
                        const expiresAt = Date.now() + (24 * 60 * 60 * 1000);
                        
                        await addDoc(roomsCol, {
                            name: name.trim(),
                            name_lower: nameLower, 
                            created_by: currentUser.uid,
                            password_hash,
                            created_at: Date.now(),
                            expires_at: expiresAt,
                            is_dm: false
                        });
                        showCustomAlert('Room created. Expires in 24h.', 'Success');
                    } catch(e) {
                        showCustomAlert('Create failed: ' + e.message, 'Error');
                    }
                }, "Security Settings", "Leave empty for public");
            }, "New Room", "e.g. General Ops");
        }

        async function deleteRoom(id) {
            showCustomConfirm("Terminate this room?", async (confirmed) => {
                if (confirmed) {
                    const { deleteDoc, doc } = window.firebaseModules;
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', id));
                        if (currentRoomId === id) goBack();
                    } catch(e) {
                        showCustomAlert("Failed: " + e.message, 'Error');
                    }
                }
            }, 'Confirm Termination', 'Terminate', 'Cancel');
        }

        async function startDM(user) {
            const ids = [currentUser.uid, user.id].sort();
            const dmId = `${ids[0]}_${ids[1]}`;
            
            // LOGIC: Alias (no @) OR @Username
            const dmName = user.alias ? user.alias : `@${user.username}`;

            const { doc, getDoc, setDoc } = window.firebaseModules;
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', dmId);
            
            const snap = await getDoc(roomRef);
            if(!snap.exists()) {
                await setDoc(roomRef, {
                    id: dmId, 
                    name: dmName,
                    created_by: currentUser.uid,
                    created_at: Date.now(),
                    is_dm: true,
                    expires_at: Date.now() + (365 * 24 * 60 * 60 * 1000) 
                });
            }
            openRoom(dmId, dmName, null, { expires_at: Date.now() + (365 * 24 * 60 * 60 * 1000)});
        }

        // FIXED: Improved goBack robustness
        function goBack() {
            if(currentRoomId) { 
                // Fire and forget
                updateTypingStatus(false).catch(e => console.log(e));
                if(typingUnsubscribe) { typingUnsubscribe(); typingUnsubscribe = null; }
                
                currentRoomId = null; 
                currentRoomData = null;
                if(messageUnsubscribe) { messageUnsubscribe(); messageUnsubscribe = null; }
            }
            switchPanel('room-list-panel');
        }
        
        async function updateProfile() {
            const { updateDoc, doc } = window.firebaseModules;
            const updates = { 
                username: getEl('edit-username').value, 
                username_lower: getEl('edit-username').value.toLowerCase(),
                alias: getEl('edit-alias').value,
                bio: getEl('edit-bio').value, 
                avatar: getEl('edit-avatar').value,
                updated_at: new Date().toISOString() 
            };
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', currentUser.uid), updates);
                showCustomAlert("Identity Updated!", 'Success');
                closeProfileModal();
            } catch(e) {
                showCustomAlert("Error: " + e.message, 'Update Failed');
            }
        }

        // Auth
        async function handleLogin() {
            clearInlineErrors();
            const btn = getEl('btn-login'); btn.textContent = "Authenticating...";
            const originalText = btn.textContent;
            const inputVal = getEl('l-email').value.trim();
            const password = getEl('l-pass').value;
            
            if(!inputVal || !password) {
                setInlineError('login-error-email', "Credentials missing.");
                return;
            }

            btn.textContent = "CONNECTING...";
            btn.disabled = true;

            const { signInWithEmailAndPassword, getDocs, query, where } = window.firebaseModules;
            
            let emailToUse = inputVal;
            
            if (!inputVal.includes('@')) {
                try {
                    const profilesCol = getPublicCollection('profiles');
                    const q = query(profilesCol, where('username', '==', inputVal));
                    const snap = await getDocs(q);
                    
                    if (snap.empty) {
                        setInlineError('login-error-email', "Username not found.");
                        btn.textContent = originalText;
                        btn.disabled = false;
                        return;
                    }
                    emailToUse = snap.docs[0].data().email;
                } catch(err) {
                    console.error(err);
                    showCustomAlert("Error verifying username.", "System Error");
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }
            }

            try {
                const cred = await signInWithEmailAndPassword(auth, emailToUse, password);
                // Note: onAuthStateChanged handles the routing and verification check
                btn.textContent = "SUCCESS";
            } catch(e) {
                btn.textContent = originalText;
                btn.disabled = false;
                
                if(e.code === 'auth/invalid-email' || e.code === 'auth/user-not-found') {
                    setInlineError('login-error-email', "Invalid or unknown user.");
                } else if(e.code === 'auth/wrong-password') {
                    setInlineError('login-error-pass', "Invalid passphrase.");
                } else {
                    showCustomAlert(e.message, 'Login Failed');
                }
            }
        }

        async function handleSignup() {
            clearInlineErrors();
            const btn = getEl('btn-signup'); 
            const originalText = btn.textContent;

            btn.textContent = "PROCESSING...";
            btn.disabled = true;

            const { createUserWithEmailAndPassword, setDoc, doc, sendEmailVerification, signOut } = window.firebaseModules;
            const email = getEl('s-email').value;
            const password = getEl('s-pass').value;
            const username = getEl('s-username').value;
            const alias = getEl('s-alias').value;

            if(!username) {
                setInlineError('signup-error-user', "Username required.");
                btn.textContent = originalText;
                btn.disabled = false;
                return;
            }

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                
                // Send verification
                await sendEmailVerification(cred.user);

                // Create profile immediately
                const avatar = `https://api.dicebear.com/7.x/bottts/svg?seed=${cred.user.uid}`;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', cred.user.uid), {
                    id: cred.user.uid,
                    username: username,
                    username_lower: username.toLowerCase(), 
                    alias: alias,
                    email: email,
                    avatar: avatar,
                    status: 'online',
                    lat: null, lon: null
                });

                // Sign out immediately to enforce verification loop
                await signOut(auth);

                showCustomAlert("Identity Created. Verification email sent. Please check your inbox to activate.", 'Action Required');
                
                // Return to login view
                getEl('f-signup').classList.add('hidden');
                getEl('f-login').classList.remove('hidden');
                getEl('l-email').value = email;
                
                btn.textContent = originalText;
                btn.disabled = false;

            } catch(e) {
                btn.textContent = originalText;
                btn.disabled = false;
                
                if(e.code === 'auth/email-already-in-use') setInlineError('signup-error-email', "Email already registered.");
                else if(e.code === 'auth/weak-password') setInlineError('signup-error-pass', "Password too weak.");
                else showCustomAlert(e.message, 'Registration Failed');
            }
        }
        
        async function resendVerification() {
            const { sendEmailVerification } = window.firebaseModules;
            if(currentUser) {
                try {
                    await sendEmailVerification(currentUser);
                    showCustomAlert("Verification email sent.", "Success");
                } catch(e) {
                    showCustomAlert("Wait before retrying.", "Rate Limit");
                }
            }
        }
        
        async function checkVerification() {
            const { onAuthStateChanged } = window.firebaseModules;
            if(currentUser) {
                await currentUser.reload();
                if(currentUser.emailVerified) {
                    // State change listener will catch this
                    window.location.reload();
                } else {
                    showCustomAlert("Email still not verified. Check spam folder.", "Not Verified");
                }
            }
        }

        // 6. Forgot Password
        async function handleForgotPassword() {
            const email = getEl('l-email').value;
            if(!email || !email.includes('@')) {
                setInlineError('login-error-email', "Enter a valid email first.");
                return;
            }
            const { sendPasswordResetEmail } = window.firebaseModules;
            try {
                await sendPasswordResetEmail(auth, email);
                showCustomAlert(`Reset link sent to ${email}. Check your inbox.`, "Link Sent");
            } catch(e) {
                showCustomAlert(e.message, "Error");
            }
        }

        function handleLogout() { window.firebaseModules.signOut(auth); window.location.reload(); }
    </script>
</head>
<body>
    <!-- CUSTOM ALERT MODAL -->
    <div id="custom-modal-backdrop" class="alert-modal-backdrop hidden" onclick="closeModal(false)">
        <div id="custom-modal-content" class="alert-modal" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="alert-title">Alert</h3>
            <p id="modal-message" class="alert-message"></p>
            <input id="modal-input" type="text" class="input-field alert-input hidden" onkeypress="handleModalKey(event)">
            <div class="alert-actions">
                <button id="modal-cancel-btn" class="btn-ghost hidden" onclick="closeModal(false)">Cancel</button>
                <button id="modal-ok-btn" class="btn btn-sm" onclick="closeModal(true)">OK</button>
            </div>
        </div>
    </div>

    <!-- OVERLAY -->
    <div id="overlay" class="overlay" onclick="toggleSidebar(false)"></div>

    <!-- 2. INVITE LINK MODAL -->
    <div id="invite-overlay" class="blur-modal-overlay" onclick="closeInviteModal()">
        <div class="modal-card" style="text-align:center;" onclick="event.stopPropagation()">
             <h2 style="font-size:1.25rem; font-weight:bold; color:var(--text); margin-bottom:1rem;">INVITE AGENTS</h2>
             <p style="font-size:0.75rem; color:var(--text-muted); margin-bottom:1rem;">Share this secure link to grant access to this frequency.</p>
             
             <input id="invite-link-text" type="text" class="input-field" style="text-align:center; font-family:monospace; font-size:0.75rem; margin-bottom:1rem;" readonly onclick="this.select()">
             
             <button onclick="copyInviteLink()" class="btn">COPY LINK</button>
             <button onclick="closeInviteModal()" style="background:none; border:none; cursor:pointer; color:var(--text-muted); font-size:0.75rem; font-weight:bold; margin-top:0.75rem;">CLOSE</button>
        </div>
    </div>

    <!-- 4. PROFILE MODAL -->
    <div id="profile-overlay" class="blur-modal-overlay" onclick="closeProfileModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <button onclick="closeProfileModal()" style="position:absolute; top:1rem; right:1rem; background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:1.25rem;"><i class="fas fa-times"></i></button>
            <h2 style="font-size:1.5rem; font-weight:bold; color:var(--text); margin-bottom:1.5rem; text-align:center; letter-spacing:0.05em;">EDIT IDENTITY</h2>
            
            <div style="display:flex; justify-content:center; margin-bottom:1.5rem;">
                <div style="position:relative;">
                    <img id="edit-avatar-preview" src="" style="width:4rem; height:4rem; border-radius:0.75rem; border:2px solid var(--primary); box-shadow:0 0 30px rgba(245,158,11,0.3);" onerror="this.src='https://api.dicebear.com/9.x/bottts-neutral/svg?seed=fallback'">
                </div>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:1rem;">
                <div>
                    <label style="font-size:0.75rem; font-weight:bold; color:var(--text-muted); margin-left:0.25rem; margin-bottom:0.25rem; display:block;">CUSTOM AVATAR URL</label>
                    <input id="edit-avatar" type="text" class="input-field" placeholder="https://..." oninput="document.getElementById('edit-avatar-preview').src = this.value">
                </div>
                
                <div>
                    <label style="font-size:0.75rem; font-weight:bold; color:var(--text-muted); margin-left:0.25rem; margin-bottom:0.25rem; display:block;">ALIAS / NICKNAME</label>
                    <input id="edit-alias" type="text" class="input-field" placeholder="callsign">
                </div>
                <div>
                    <label style="font-size:0.75rem; font-weight:bold; color:var(--text-muted); margin-left:0.25rem; margin-bottom:0.25rem; display:block;">USERNAME</label>
                    <input id="edit-username" type="text" class="input-field">
                </div>
                <div>
                    <label style="font-size:0.75rem; font-weight:bold; color:var(--text-muted); margin-left:0.25rem; margin-bottom:0.25rem; display:block;">BIO DATA</label>
                    <textarea id="edit-bio" rows="3" class="input-field" style="resize:none;"></textarea>
                </div>
                <button onclick="updateProfile()" class="btn">SAVE CHANGES</button>
                
                <div style="border-top:1px solid var(--border); padding-top:1rem; margin-top:1rem;">
                    <button onclick="handleLogout()" class="btn" style="background:var(--danger);">SIGN OUT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AUTH -->
    <div id="auth-view" class="hidden" style="display:flex; align-items:center; justify-content:center; width:100%; height:100%; padding:1rem;">
        <div class="glass-card text-center">
            <h1 class="auth-header">UNIWORLD</h1>
            
            <!-- VERIFICATION VIEW (Hidden by default) -->
            <div id="verification-view" class="hidden" style="display:flex; flex-direction:column; gap:1.5rem;">
                <div style="padding:1rem; border:1px solid rgba(245,158,11,0.3); background:rgba(245,158,11,0.1); border-radius:0.5rem;">
                    <i class="fas fa-envelope-open-text" style="font-size:2.25rem; color:var(--primary); margin-bottom:1rem;"></i>
                    <h2 style="font-size:1.25rem; font-weight:bold; color:var(--primary); margin-bottom:0.5rem;">Verification Required</h2>
                    <p style="font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem;">We sent a link to:</p>
                    <div id="v-email-display" class="font-mono" style="color:white; background:rgba(0,0,0,0.3); padding:0.5rem; border-radius:0.25rem; margin-bottom:0.5rem; font-size:0.875rem;"></div>
                    <p style="font-size:0.75rem; color:var(--text-muted);">Please check your inbox (and spam) to activate your account.</p>
                </div>
                
                <button onclick="checkVerification()" class="btn" style="background:var(--green-500);">I'VE VERIFIED (RELOAD)</button>
                <button onclick="resendVerification()" style="background:none; border:none; cursor:pointer; font-size:0.75rem; color:var(--primary); display:block; width:100%; margin-top:0.5rem;">Resend Email</button>
                <button onclick="handleLogout()" style="background:none; border:none; cursor:pointer; font-size:0.75rem; color:var(--gray-500); display:block; width:100%; margin-top:1rem;">Back to Login</button>
            </div>

            <div id="f-login" style="display:flex; flex-direction:column; gap:1rem;">
                <div>
                    <input id="l-email" type="text" class="input-field" placeholder="Access ID (Email or Username)">
                    <div id="login-error-email" class="inline-error"></div>
                </div>
                
                <!-- Grouped Password & Forgot Password to remove gap -->
                <div>
                    <div class="input-group">
                        <input id="l-pass" type="password" class="input-field" placeholder="Passphrase" style="padding-right: 40px;">
                        <i id="toggle-l-pass" class="fas fa-eye password-toggle" onclick="togglePassword('l-pass', 'toggle-l-pass')"></i>
                    </div>
                    <div id="login-error-pass" class="inline-error"></div>

                    <div class="text-right" style="width:100%;">
                        <button onclick="handleForgotPassword()" style="background:none; border:none; cursor:pointer; font-size:0.75rem; color:var(--primary);">Forgot password?</button>
                    </div>
                </div>

                <button id="btn-login" onclick="handleLogin()" class="btn">ESTABLISH LINK</button>
                
                <div onclick="getEl('f-login').classList.add('hidden'); getEl('f-signup').classList.remove('hidden')" class="auth-toggle-btn">
                    GENERATE NEW IDENTITY
                </div>
            </div>

            <div id="f-signup" class="hidden" style="display:flex; flex-direction:column; gap:1rem;">
                <div>
                    <input id="s-username" type="text" class="input-field" placeholder="Username (Required)">
                    <div id="signup-error-user" class="inline-error"></div>
                </div>
                <input id="s-alias" type="text" class="input-field" placeholder="Alias / Nickname (Optional)">
                
                <div>
                    <input id="s-email" type="email" class="input-field" placeholder="Email">
                    <div id="signup-error-email" class="inline-error"></div>
                </div>
                
                <div class="input-group">
                    <input id="s-pass" type="password" class="input-field" placeholder="Password" style="padding-right: 40px;">
                    <i id="toggle-s-pass" class="fas fa-eye password-toggle" onclick="togglePassword('s-pass', 'toggle-s-pass')"></i>
                </div>
                <div id="signup-error-pass" class="inline-error"></div>

                <button id="btn-signup" onclick="handleSignup()" class="btn">REGISTER</button>
                
                <div onclick="getEl('f-signup').classList.add('hidden'); getEl('f-login').classList.remove('hidden')" class="auth-toggle-btn">
                    ABORT / BACK TO LOGIN
                </div>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="app-view" class="hidden h-full w-full">
        <div class="app-container">
            <!-- SIDEBAR -->
            <div id="sidebar" class="sidebar">
                <div class="sidebar-profile">
                    <img id="my-avatar" class="profile-avatar-small" onclick="openProfileModal()" onerror="this.src='https://api.dicebear.com/9.x/bottts-neutral/svg?seed=fallback'">
                    <div class="profile-info" onclick="openProfileModal()">
                        <div class="profile-name" id="my-name">Anon User</div>
                        <div class="profile-status">
                            STATUS: <span id="status-indicator" style="color:var(--gray-500);">●</span> SECURE
                        </div>
                    </div>
                    <!-- NEW THEME TOGGLE -->
                    <button id="theme-toggle-btn" onclick="event.stopPropagation(); toggleTheme()" class="icon-btn"><i id="theme-toggle-icon" class="fas fa-sun" style="font-size:0.75rem;"></i></button>
                </div>
                
                <div class="sidebar-nav">
                    <button onclick="switchPanel('room-list-panel')"><i class="fas fa-hashtag"></i> ROOMS</button>
                    <button onclick="openProfileModal()"><i class="fas fa-sliders-h"></i> SETTINGS</button>
                </div>

                <div class="my-rooms-container">
                    <div class="section-label">MY ROOMS</div>
                    <div id="my-rooms-list" class="my-rooms-list"></div>
                </div>

                <div class="active-nodes-container">
                    <div class="section-label">ACTIVE NODES</div>
                    <div id="user-list" class="user-list"></div>
                </div>
            </div>

            <!-- MAIN -->
            <div class="main-area">
                <div class="mobile-header">
                    <button onclick="toggleSidebar(true)" style="background:none; border:none; font-size:1.25rem; color:var(--primary); padding:0.5rem; cursor:pointer;"><i class="fas fa-bars"></i></button>
                    <span style="font-weight:bold; font-size:1.25rem; letter-spacing:-0.025em; color:var(--primary); font-family:monospace;">UNIWORLD</span>
                    <div style="width:2rem;"></div>
                </div>

                <div id="room-list-panel" class="panel-content">
                    <div class="header-row">
                        <div class="header-title"><h2>ROOMS</h2><p>Select a frequency</p></div>
                        <button onclick="createRoom()" class="new-room-btn">+ NEW</button>
                    </div>
                    
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input id="room-search" type="text" class="search-input" placeholder="Search rooms...">
                        <button onclick="clearSearch()" class="search-clear"><i class="fas fa-times"></i></button>
                    </div>

                    <div id="room-grid" class="room-grid"></div>
                </div>

                <div id="chat-interface" class="chat-interface hidden">
                    <div class="chat-header">
                        <button onclick="goBack()" style="color:var(--text); margin-right:0.75rem; padding:0.5rem; background:var(--input-bg); border-radius:0.5rem; border:1px solid var(--border); cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
                        <div class="chat-header-info">
                            <div class="chat-header-title"><span style="color:var(--primary);">#</span> <span id="chat-header-name" class="truncate">Room</span></div>
                            <div id="chat-header-timer" class="chat-header-timer"></div>
                        </div>
                        <div id="header-actions"></div>
                    </div>
                    
                    <div id="typing-indicator" class="typing-indicator"></div>

                    <div id="msg-box" class="msg-box"></div>
                    
                    <div class="chat-input-wrapper">
                        <div id="mention-dropdown" class="mention-dropdown"></div>
                        
                        <input id="msg-inp" type="text" class="chat-input" placeholder="Encrypting message... (Type @ to mention)" onkeypress="if(event.key==='Enter') sendMsg()">
                        <button onclick="sendMsg()" class="send-btn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
